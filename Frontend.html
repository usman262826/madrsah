<!doctype html>
<html lang="bn">
<head>
  <base target="_top" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶∏ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</title>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.maateen.me/kalpurush/font.css" rel="stylesheet">

  <style>
    /* ------------------------------------
       ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶≠‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ (‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶•‡¶ø‡¶Æ)
       ------------------------------------ */
    :root{
      --accent: #06b6d4; /* cyan-500-ish */
      --muted: #002d6b; ¬†/* gray */
      --bg: #0b1220; ¬† ¬† /* dark bg */
      --card: #0f172a;
      --input-bg: rgba(255,255,255,0.05);
    }
    body{ 
        font-family: "Kalpurush", "Noto Sans Bengali", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", sans-serif; 
        background:linear-gradient(180deg, #071126 0%, #08192a 60%); 
        color: #e2e8f0; /* Light text color */
    }
    /* subtle animation for card */
    .card-anim{ 
        transform:translateY(6px); 
        transition: transform .35s cubic-bezier(.2,.9,.2,1), box-shadow .35s ease; 
        background-color: var(--card); /* Base card bg */
    }
    .card-anim:hover{ 
        transform:translateY(0); 
        box-shadow: 0 12px 30px rgba(2,6,23,.6); 
    }
    /* input focus & style */
    input, select {
        background-color: var(--input-bg);
        border: 1px solid rgba(255,255,255,0.06);
        transition: border-color .3s, box-shadow .3s;
    }
    input:focus, select:focus, button:focus { 
        outline: none; 
        box-shadow: 0 0 0 3px rgba(6,182,212,0.25); 
        border-color: var(--accent); 
    }
    /* small animation for toast */
    .fade-in { animation: fadeIn .4s ease forwards; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }
    
    /* Custom Scrollbar for dark theme */
    .overflow-x-auto::-webkit-scrollbar { height: 6px; }
    .overflow-x-auto::-webkit-scrollbar-track { background: var(--bg); }
    .overflow-x-auto::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Teacher Profile Style */
    #teacherCard {
        background: linear-gradient(90deg, #0f172a, #1e293b);
        border: 1px solid rgba(255,255,255,0.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    /* Login Button Gradient */
    .login-btn-gradient {
        background: linear-gradient(90deg, #06b6d4, #0891b2);
        transition: all 0.3s ease;
    }
    .login-btn-gradient:hover {
        opacity: 0.9;
    }
    /* Submit Button Gradient */
    .submit-btn-gradient {
        background: linear-gradient(90deg, #4f46e5, #6366f1);
        transition: all 0.3s ease;
    }
    .submit-btn-gradient:hover {
        opacity: 0.9;
    }
    
    /* Table Header */
    #studentsTHead th {
        background-color: #1e293b;
    }
    
    /* Subject Select Item Style */
    .subject-control-wrapper {
      position: relative;
    }
    .remove-btn {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 6px;
      background-color: #ef4444; /* Red 500 */
      color: white;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body class="min-h-screen text-gray-100">
  <div class="max-w-xl mx-auto p-4 md:p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-extrabold text-cyan-400 text-center">‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶∏ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h1>
      <p class="text-sm text-gray-400 mt-1 text-center">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤-‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶≤‡¶ø ‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶•‡¶ø‡¶Æ | ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶∏ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</p>
    </header>

    <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-8 hidden z-50">
      <div id="toastMsg" class="bg-white/10 backdrop-blur-md text-white px-4 py-2 rounded-full shadow-lg text-sm flex items-center gap-2"></div>
    </div>

    <section id="loginCard" class="card-anim rounded-2xl p-5 mb-6 shadow-2xl">
      <h2 class="text-xl font-semibold mb-4 text-cyan-300">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
      <div class="space-y-4">
        <div>
          <label class="text-sm text-gray-400 block mb-1">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® </label>
          <input id="mobileInput" inputmode="numeric" maxlength="20" placeholder="01XXX-XX XX XX" class="w-full p-3 rounded-lg text-white" />
          <p class="text-xs text-gray-500 mt-1"></p>
        </div>
        <div>
          <label class="text-sm text-gray-400 block mb-1">‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç</label>
          <input id="idInput" placeholder="‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="w-full p-3 rounded-lg text-white" />
        </div>
        <div class="flex gap-3 pt-2">
          <button id="loginBtn" class="flex-1 py-3 rounded-lg login-btn-gradient font-bold shadow-lg shadow-cyan-900/50">‡¶≤‡¶ó‡¶á‡¶®</button>
          <button id="clearBtn" class="py-3 px-5 rounded-lg border border-gray-700 text-gray-300 bg-gray-800/50 hover:bg-gray-700/50 transition">‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞</button>
        </div>
        <div id="loginStatus" class="hidden mt-3 p-3 rounded-lg text-sm transition"></div>
      </div>
    </section>

    <section id="teacherCard" class="hidden rounded-xl p-4 mb-6 shadow-xl transition-all duration-500 ease-out" style="animation: fadeIn 0.5s ease;">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-cyan-500/10 flex items-center justify-center text-xl font-bold border border-cyan-500/50">‡¶ì</div>
            <div>
              <div id="teacherName" class="text-lg font-bold text-white">‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ</div>
              <div class="flex gap-2 text-xs text-gray-400">
                  <span id="teacherTitle" class="bg-cyan-500/20 px-2 py-0.5 rounded-full">‡¶™‡¶¶‡¶¨‡ßÄ</span>
                  <span id="teacherPosition" class="bg-indigo-500/20 px-2 py-0.5 rounded-full">‡¶™‡¶¶/‡¶ß‡¶∞‡¶®</span>
              </div>
            </div>
        </div>
        <button id="logoutBtn" class="text-sm text-gray-400 hover:text-red-400 transition" onclick="resetApp()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
      </div>
    </section>

    <section id="selectionCard" class="hidden card-anim rounded-2xl p-5 mb-6 shadow-xl transition-all duration-500 ease-out">
      <h3 class="text-lg font-semibold mb-4 text-gray-300">‡¶¨‡¶ø‡¶∑‡ßü ‡¶ì ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</h3>
      <div class="space-y-4">
        <div>
          <label class="text-xs text-gray-400">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑</label>
          <select id="shikkhaborsho" class="w-full mt-1 p-3 rounded-lg text-white">
            <option value="‡ßß‡ß™‡ß™‡ß´-‡ß™‡ß¨ ‡¶π‡¶ø‡¶ú‡¶∞‡ßÄ/‡ß®‡ß¶‡ß®‡ß´-‡ß®‡ß¨ ‡¶à‡¶∏‡¶æ‡ßü‡ßÄ">‡ßß‡ß™‡ß™‡ß´-‡ß™‡ß¨ ‡¶π‡¶ø‡¶ú‡¶∞‡ßÄ/‡ß®‡ß¶‡ß®‡ß´-‡ß®‡ß¨ ‡¶à‡¶∏‡¶æ‡ßü‡ßÄ</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-400">‡¶™‡¶∞‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
          <select id="shikkhaborsho" class="w-full mt-1 p-3 rounded-lg text-white">
            <option value="‡ßß‡ß™‡ß™‡ß´-‡ß™‡ß¨ ‡¶π‡¶ø‡¶ú‡¶∞‡ßÄ/‡ß®‡ß¶‡ß®‡ß´-‡ß®‡ß¨ ‡¶à‡¶∏‡¶æ‡ßü‡ßÄ">‡ßß‡¶Æ ‡¶∏‡¶æ‡¶Æ‡ßü‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
            <option value="‡ßß‡ß™‡ß™‡ß´-‡ß™‡ß¨ ‡¶π‡¶ø‡¶ú‡¶∞‡ßÄ/‡ß®‡ß¶‡ß®‡ß´-‡ß®‡ß¨ ‡¶à‡¶∏‡¶æ‡ßü‡ßÄ">‡ß®‡ßü ‡¶∏‡¶æ‡¶Æ‡ßü‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
            <option value="‡ßß‡ß™‡ß™‡ß´-‡ß™‡ß¨ ‡¶π‡¶ø‡¶ú‡¶∞‡ßÄ/‡ß®‡ß¶‡ß®‡ß´-‡ß®‡ß¨ ‡¶à‡¶∏‡¶æ‡ßü‡ßÄ">‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-gray-400">‡¶ú‡¶æ‡¶Æ‡¶æ‡¶§ (‡¶ï‡ßç‡¶≤‡¶æ‡¶∏) ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</label>
          <select id="classSelect" class="w-full mt-1 p-3 rounded-lg text-white transition-all duration-300">
            <option value="">-- ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
          </select>
        </div>

        <div id="subjectArea">
          <label class="text-xs text-gray-400 block mb-2">‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º/‡¶ï‡¶ø‡¶§‡¶æ‡¶¨ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® (‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®)</label>
          <div id="subjectsWrapper" class="space-y-3">
            </div>

          <button id="addSubjectBtn" class="w-full py-2 mt-3 rounded-lg border border-cyan-600 text-cyan-300 hover:bg-cyan-900/50 transition">
            <span class="font-medium">+ ‡¶Ü‡¶∞‡¶ì ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</span>
          </button>
        </div>

        <div class="flex gap-3 pt-2">
          <button id="loadStudentsBtn" class="flex-1 py-3 rounded-lg bg-gradient-to-r from-emerald-500 to-green-400 font-bold shadow-lg shadow-emerald-900/50 transition">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã</button>
          <button id="resetSubjectsBtn" class="py-3 px-5 rounded-lg border border-gray-700 text-gray-300 bg-gray-800/50 hover:bg-gray-700/50 transition" onclick="resetSubjects()">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
        </div>
      </div>
    </section>

    <section id="studentsCard" class="hidden card-anim rounded-2xl p-5 mb-6 shadow-xl transition-all duration-500 ease-out">
      <h3 class="text-lg font-semibold mb-4 text-indigo-300">‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
      <div class="overflow-x-auto">
        <table id="studentsTable" class="min-w-full text-sm text-gray-200">
          <thead id="studentsTHead" class="text-left sticky top-0 bg-gray-900/90 backdrop-blur-sm z-10"></thead>
          <tbody id="studentsTBody"></tbody>
        </table>
      </div>

      <div class="mt-5 space-y-3">
        <div class="text-xs text-gray-500 p-2 rounded bg-red-900/10 border border-red-900/30">
          ‚ö†Ô∏è ‡¶®‡ßã‡¶ü: ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ì ‡¶∞‡ßã‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ (0-9) ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§
        </div>
        <button id="submitMarksBtn" class="w-full py-3 rounded-lg submit-btn-gradient font-bold shadow-lg shadow-indigo-900/50 transition">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßã</button>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-gray-500">
      ¬© ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶æ‡¶≤ ‚Äî ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶° ‡¶â‡¶á‡¶• ‡¶â‡¶∏‡¶Æ‡¶æ‡¶® ‡¶∏‡¶æ‡¶à‡¶¶
    </footer>
  </div>

<script>
/* ===========================
    CONFIG - ‡¶è‡¶á WEBAPP_URL ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    =========================== */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwh8y322YVRopEQW63q_pjRDFeMgFK-b2c6cqu0lrvG6Er_V-ACEfbSnwk2vVmJ2yp-sw/exec"; // <-- ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Deploy ‡¶ï‡¶∞‡¶æ Apps Script Webapp URL ‡¶¶‡¶ø‡¶®

let classesData = []; 
let studentsCache = []; // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ
let currentSubjectMeta = []; // { subject: "‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º", columnTitle: "‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ" }

const ALL_KUTUB_STATIC = {
  '‡¶Ü‡¶ì‡ßü‡¶æ‡¶≤ (‡ßß‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ)': ['‡¶Ü‡¶∞‡¶¨‡¶ø', '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', '‡¶ó‡¶®‡¶ø‡¶§', '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø', '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ú‡ßç‡¶û‡¶æ‡¶®', '‡¶π‡¶æ‡¶¶‡ßÄ‡¶∏ ‡¶ì ‡¶Æ‡¶æ‡¶∏‡¶Ü‡¶≤‡¶æ', '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ‡ßé'],
  '‡¶õ‡¶æ‡¶®‡ßÄ (‡ß®‡ßü ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ)': ['‡¶Ü‡¶∞‡¶¨‡¶ø', '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', '‡¶ó‡¶®‡¶ø‡¶§', '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø', '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ú‡ßç‡¶û‡¶æ‡¶®', '‡¶π‡¶æ‡¶¶‡ßÄ‡¶∏ ‡¶ì ‡¶Æ‡¶æ‡¶∏‡¶Ü‡¶≤‡¶æ', '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ‡ßé'],
  '‡¶õ‡¶æ‡¶≤‡ßá‡¶õ (‡ß©‡ßü ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ)': ['‡¶Ü‡¶∞‡¶¨‡¶ø', '‡¶â‡¶∞‡ßç‡¶¶‡ßÇ ‡¶ï‡¶æ‡ßü‡¶¶‡¶æ', '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', '‡¶ó‡¶®‡¶ø‡¶§', '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶≠‡ßÇ‡¶ó‡ßã‡¶≤', '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø', '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ú‡ßç‡¶û‡¶æ‡¶®', '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ'],
  '‡¶ñ‡ßÅ‡¶∏‡ßÅ‡¶õ‡¶ø (‡¶á‡¶¨‡¶§‡ßá‡¶¶‡¶æ‡ßü‡¶ø ‡¶∞‡¶æ‡¶¨‡ßá)': ['‡¶â‡¶∞‡ßç‡¶¶‡ßÇ ‡¶™‡ßá‡¶π‡ßá‡¶≤‡ßÄ', '‡¶ó‡¶£‡¶ø‡¶§', '‡¶Ü‡¶∞‡¶¨‡¶ø', '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶≠‡ßÇ‡¶ó‡ßã‡¶≤', '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ú‡ßç‡¶û‡¶æ‡¶®', '‡¶§‡¶æ‡¶≤‡¶ø‡¶Æ‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ', '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø', '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ'],
  '‡¶Æ‡¶ø‡¶Ø‡¶æ‡¶® (‡¶Æ‡ßÅ‡¶§‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∏‡¶∏‡¶ø‡¶§‡¶æ‡¶π ‡¶Ü‡¶ì‡ßü‡¶æ‡¶≤)': ['‡¶Æ‡¶ø‡¶ú‡¶æ‡¶®‡ßÅ‡¶∏ ‡¶∏‡¶∞‡¶´', '‡¶è‡¶∏‡ßã ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶∂‡¶ø‡¶ñ‡¶ø', '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø', '‡¶¨‡ßá‡¶π‡ßá‡¶∂‡¶§‡ßá ‡¶ú‡ßá‡¶ì‡¶∞', '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ', '‡¶ó‡¶£‡¶ø‡¶§', '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ'],
  '‡¶®‡¶æ‡¶π‡¶¨‡ßá‡¶Æ‡ßÄ‡¶∞ (‡¶Æ‡ßÅ‡¶§‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∏‡¶∏‡¶ø‡¶§‡¶æ‡¶π ‡¶õ‡¶æ‡¶®‡¶ø)': ['‡¶®‡¶æ‡¶π‡ßÅ‡¶Æ‡ßÄ‡¶∞', '‡¶∞‡¶ì‡¶ú‡¶æ‡¶§‡ßÅ‡¶≤ ‡¶Ü‡¶¶‡¶¨', '‡¶∏‡¶ø‡¶∞‡¶æ‡¶§‡ßá ‡¶ñ‡¶æ‡¶§‡¶æ‡¶Æ‡ßÅ‡¶≤ ‡¶Ü‡¶Æ‡ßç‡¶¨‡¶ø‡ßü‡¶æ', '‡¶∂‡¶∞‡¶π‡ßá ‡¶Æ‡¶ø‡ßü‡¶æ‡¶§‡ßá ‡¶Ü‡¶Æ‡ßá‡¶≤', '‡¶™‡¶æ‡¶û‡ßç‡¶ú‡ßá‡¶ó‡¶æ‡¶û‡ßç‡¶ú', '‡¶Ü‡¶≤ ‡¶´‡¶ø‡¶ï‡¶π‡ßÅ‡¶≤ ‡¶Æ‡ßÅ‡ßü‡¶æ‡¶∏‡¶∏‡¶æ‡¶∞', '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ'],
  '‡¶∂‡¶∞‡¶π‡ßá ‡¶¨‡ßá‡¶ï‡¶æ‡ßü‡¶æ (‡¶∏‡¶æ‡¶®‡¶æ‡¶¨‡¶ø‡ßü‡ßç‡¶Ø‡¶æ ‡¶õ‡¶æ‡¶®‡ßÄ)': ['‡¶∂‡¶∞‡¶π‡ßá ‡¶¨‡ßá‡¶ï‡¶æ‡ßü‡¶æ (‡ßß‡¶Æ ‡¶ñ‡¶®‡ßç‡¶°)', '‡¶Ü‡¶§‡ßç‡¶¨ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ï‡ßÅ ‡¶á‡¶≤‡¶æ‡¶≤ ‡¶á‡¶®‡¶∂‡¶æ', '‡¶∂‡¶∞‡¶π‡ßá ‡¶¨‡ßá‡¶ï‡¶æ‡ßü‡¶æ (‡ß®‡ßü ‡¶ñ‡¶®‡ßç‡¶°)', '‡¶ï‡¶æ‡¶´‡¶ø‡ßü‡¶æ', '‡¶§‡¶∞‡¶ú‡¶Æ‡¶æ‡¶§‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®', '‡¶¶‡ßÅ‡¶∞‡ßÅ‡¶∏‡ßÅ‡¶≤ ‡¶¨‡¶æ‡¶≤‡¶æ‡¶ó‡¶æ‡¶§', '‡¶®‡ßÅ‡¶∞‡ßÅ‡¶≤ ‡¶Ü‡¶®‡¶ì‡ßü‡¶æ‡¶∞', '‡¶Æ‡ßÅ‡¶ñ‡¶§‡¶æ‡¶∞‡¶æ‡¶§', '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ'],
  '‡¶Æ‡ßá‡¶∂‡¶ï‡¶æ‡¶§ (‡¶´‡¶ú‡¶ø‡¶≤‡¶§ ‡¶õ‡¶æ‡¶®‡ßÄ)': ['‡¶Æ‡ßá‡¶∂‡¶ï‡¶æ‡¶§‡ßÅ‡¶≤ ‡¶Æ‡¶æ‡¶∏‡¶æ‡¶¨‡¶ø‡¶π (‡ßß‡¶Æ ‡¶ñ‡¶®‡ßç‡¶°)', '‡¶Æ‡ßá‡¶∂‡¶ï‡¶æ‡¶§‡ßÅ‡¶≤ ‡¶Æ‡¶æ‡¶∏‡¶æ‡¶¨‡¶ø‡¶π (‡ß®‡ßü ‡¶ñ‡¶®‡ßç‡¶°)', '‡¶π‡ßá‡¶¶‡¶æ‡ßü‡¶æ (‡ß©‡ßü ‡¶ñ‡¶®‡ßç‡¶°)', '‡¶π‡ßá‡¶¶‡¶æ‡ßü‡¶æ (‡ß™‡¶∞‡ßç‡¶• ‡¶ñ‡¶®‡ßç‡¶°)', '‡¶§‡¶æ‡¶´‡¶∏‡¶ø‡¶∞‡ßá ‡¶ú‡¶æ‡¶≤‡¶æ‡¶≤‡¶æ‡¶á‡¶® (‡ßß‡¶Æ ‡¶ñ‡¶®‡ßç‡¶°)', '‡¶§‡¶æ‡¶´‡¶∏‡¶ø‡¶∞‡ßá ‡¶ú‡¶æ‡¶≤‡¶æ‡¶≤‡¶æ‡¶á‡¶® (‡ß®‡ßü ‡¶ñ‡¶®‡ßç‡¶°)', '‡¶Ü‡¶ï‡ßÄ‡¶¶‡¶æ‡¶§‡ßÅ‡¶§ ‡¶§‡ßç‡¶¨‡¶π‡¶æ‡¶¨‡ßÄ', '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ']
};

/* ---------------------------
    ‡¶á‡¶â‡¶Ü‡¶á ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏
    --------------------------- */
const mobileInput = document.getElementById('mobileInput');
const idInput = document.getElementById('idInput');
const loginBtn = document.getElementById('loginBtn');
const clearBtn = document.getElementById('clearBtn');
const loginStatus = document.getElementById('loginStatus');
const loginCard = document.getElementById('loginCard');

const teacherCard = document.getElementById('teacherCard');
const teacherTitle = document.getElementById('teacherName').nextElementSibling.querySelector('#teacherTitle'); // Target the span
const teacherName = document.getElementById('teacherName');
const teacherPosition = document.getElementById('teacherName').nextElementSibling.querySelector('#teacherPosition'); // Target the span

const selectionCard = document.getElementById('selectionCard');
const classSelect = document.getElementById('classSelect');
const subjectsWrapper = document.getElementById('subjectsWrapper');
const addSubjectBtn = document.getElementById('addSubjectBtn');
const loadStudentsBtn = document.getElementById('loadStudentsBtn');
const studentsCard = document.getElementById('studentsCard');
const studentsTHead = document.getElementById('studentsTHead');
const studentsTBody = document.getElementById('studentsTBody');
const submitMarksBtn = document.getElementById('submitMarksBtn');

const toast = document.getElementById('toast');
const toastMsg = document.getElementById('toastMsg');

/* ===========================
    ‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø: ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü
    =========================== */
mobileInput.addEventListener('input', (e) => {
  let v = e.target.value.replace(/\D/g,'').slice(0,11); 
  const a = v.slice(0,5);
  const b = v.slice(5,7);
  const c = v.slice(7,9);
  const d = v.slice(9,11);
  let out = a;
  if(b) out += "-" + b;
  if(c) out += " " + c;
  if(d) out += " " + d;
  e.target.value = out;
});

/* ===========================
    ‡¶ü‡ßã‡¶∏‡ßç‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    =========================== */
function showToast(msg, type='success', duration=3000){
  toastMsg.innerHTML = '';
  const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
  toastMsg.innerHTML = `${icon} <span class="${type === 'success' ? 'text-green-300' : type === 'error' ? 'text-red-300' : 'text-cyan-300'}">${msg}</span>`;
  toast.classList.remove('hidden');
  toast.classList.remove('fade-in');
  void toast.offsetWidth; // Force reflow
  toast.classList.add('fade-in');
  setTimeout(()=>{ toast.classList.add('hidden'); }, duration);
}

function setButtonLoading(btn, isLoading, text) {
    btn.disabled = isLoading;
    btn.textContent = isLoading ? "‡¶ö‡¶æ‡¶≤‡¶æ‡¶®‡ßã..." : text;
    btn.classList.toggle('opacity-70', isLoading);
    btn.classList.toggle('cursor-wait', isLoading);
}

/* ===========================
    ‡¶≤‡¶ó‡¶á‡¶® ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
    =========================== */
loginBtn.addEventListener('click', async () => {
  const mobile = mobileInput.value.replace(/[\s-]/g,'');
  const idno = idInput.value.trim();
  
  if(!mobile || !idno){ 
    loginStatus.className="p-3 mt-3 rounded-lg text-sm bg-yellow-900/30 text-yellow-300 transition-all duration-300"; 
    loginStatus.textContent="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶ì ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®‡•§"; 
    loginStatus.classList.remove('hidden'); 
    return; 
  }
  setButtonLoading(loginBtn, true, "‡¶≤‡¶ó‡¶á‡¶®");
  loginStatus.classList.add('hidden');

  try{
    const res = await apiPost({ action:"login", mobile, idno });
    if(res.success){
      loginStatus.className="p-3 mt-3 rounded-lg text-sm bg-green-900/30 text-green-300 transition-all duration-300";
      loginStatus.textContent = res.message || "‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤";
      
      // ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì
      teacherTitle.textContent = res.teacherInfo.postobi || "‡¶™‡¶¶‡¶¨‡ßÄ ‡¶®‡ßá‡¶á";
      teacherName.textContent = res.teacherInfo.purnonam || "‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á";
      teacherPosition.textContent = res.teacherInfo.pod_dhoron || "‡¶™‡¶¶/‡¶ß‡¶∞‡¶® ‡¶®‡ßá‡¶á";
      
      loginCard.classList.add('hidden');
      teacherCard.classList.remove('hidden');
      selectionCard.classList.remove('hidden');
      
      loadClassesAndBooks(); // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã
      showToast("‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá üéâ");
    } else {
      loginStatus.className="p-3 mt-3 rounded-lg text-sm bg-red-900/30 text-red-300 transition-all duration-300";
      loginStatus.textContent = res.message || "‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç ‡¶≠‡ßÅ‡¶≤‡•§";
      teacherCard.classList.add('hidden');
      selectionCard.classList.add('hidden');
    }
  }catch(err){
    loginStatus.className="p-3 mt-3 rounded-lg text-sm bg-red-900/30 text-red-300 transition-all duration-300";
    loginStatus.textContent = "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
    console.error("Login Error:", err);
  } finally {
    setButtonLoading(loginBtn, false, "‡¶≤‡¶ó‡¶á‡¶®");
  }
});

/* ===========================
    API POST helper (fetch)
    =========================== */
async function apiPost(payload){
  const res = await fetch(WEBAPP_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  return await res.json();
}

/* ===========================
    ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ì ‡¶¨‡¶á ‡¶≤‡ßã‡¶° (getClassesAndBooks)
    =========================== */
async function loadClassesAndBooks(){
  try{
    // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
    // const res = await apiPost({ action:"getClassesAndBooks" });
    // if(res && res.success){
    //   classesData = res.classes || [];
    //   populateClassSelect();
    // } else {
      // Static fallback ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
      classesData = Object.keys(ALL_KUTUB_STATIC).map(name => ({
        name: name,
        books: ALL_KUTUB_STATIC[name]
      }));
      populateClassSelect();
      // showToast("‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ì ‡¶¨‡¶á‡¶Ø‡¶º‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", 'info');
    // }
  }catch(e){
    console.error(e);
    showToast("‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡ßã‡¶°‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡¶ø, ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶ï ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§", 'error');
  }
}

function populateClassSelect(){
  classSelect.innerHTML = '<option value="">-- ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
  classesData.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.name; opt.textContent = c.name;
    classSelect.appendChild(opt);
  });
  resetSubjects(); // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
}

/* ===========================
    ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü UI: ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï‡¶æ‡¶≤‡¶ø ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
    =========================== */
function addSubjectControl(defaultSubject){
  const selClass = classSelect.value;
  if (!selClass && !defaultSubject) {
      showToast("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", 'error');
      return;
  }
  
  const classesObj = classesData.find(x=>x.name===selClass);
  const books = (classesObj && classesObj.books) ? classesObj.books : [];
  
  // ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ
  const selectedBooks = Array.from(subjectsWrapper.querySelectorAll('select')).map(s => s.value);
  
  const id = 'subject_control_' + Date.now();
  const wrap = document.createElement('div');
  wrap.className = 'subject-control-wrapper flex gap-2 items-center';
  wrap.id = id;

  const sel = document.createElement('select');
  sel.className = 'flex-1 p-3 rounded-lg text-white';
  sel.innerHTML = `<option value="">-- ‡¶ï‡¶ø‡¶§‡¶æ‡¶¨/‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>`;
  
  books.forEach(b => {
    // ‡¶á‡¶§‡ßã‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶Ö‡¶™‡¶∂‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
    if (!selectedBooks.includes(b)) {
        const o = document.createElement('option'); 
        o.value = b; 
        o.textContent = b; 
        sel.appendChild(o);
    }
  });
  
  // ‡¶Ø‡¶¶‡¶ø defaultSubject ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
  if(defaultSubject) sel.value = defaultSubject;

  const delBtn = document.createElement('button');
  delBtn.className = 'remove-btn bg-red-600 hover:bg-red-700 transition';
  delBtn.textContent = 'X';
  delBtn.type = 'button';
  delBtn.addEventListener('click', ()=>{ wrap.remove(); });

  wrap.appendChild(sel);
  wrap.appendChild(delBtn);

  subjectsWrapper.appendChild(wrap);
}

addSubjectBtn.addEventListener('click', ()=> addSubjectControl());

function resetSubjects(){
  subjectsWrapper.innerHTML = '';
  currentSubjectMeta = [];
  addSubjectControl();
  studentsCard.classList.add('hidden');
}

classSelect.addEventListener('change', ()=>{
  resetSubjects();
});

/* ===========================
    ‡¶≤‡ßã‡¶° ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶∏ (getStudents)
    =========================== */
loadStudentsBtn.addEventListener('click', async ()=>{
  const className = classSelect.value;
  if(!className){ showToast("‡¶ú‡¶æ‡¶Æ‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßã", 'error'); return; }

  const subjectControls = Array.from(subjectsWrapper.querySelectorAll('select'));
  const validSubjects = subjectControls.filter(s=>s.value).map((s) => s.value);
  
  if(validSubjects.length === 0){
    showToast("‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®", 'error');
    return;
  }
  
  // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
  currentSubjectMeta = validSubjects.map(subject => ({
    subject: subject,
    columnTitle: subject // ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶™‡¶æ‡¶§‡¶§ ‡¶ï‡¶ø‡¶§‡¶æ‡¶¨‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
  }));

  setButtonLoading(loadStudentsBtn, true, "‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã");
  studentsCard.classList.add('hidden');
  
  try{
    const res = await apiPost({ action:"getStudents", className });
    if(res.success){
      studentsCache = res.students;
      renderStudentsTable(res.students, currentSubjectMeta);
      studentsCard.classList.remove('hidden');
      showToast("‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úÖ");
    } else {
      showToast(res.message || "‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•", 'error');
    }
  }catch(e){
    console.error(e); 
    showToast("‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§", 'error');
  } finally {
    setButtonLoading(loadStudentsBtn, false, "‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã");
  }
});

/* ===========================
    renderStudentsTable
    =========================== */
function renderStudentsTable(students, subjectMeta){
  studentsTHead.innerHTML = '';
  studentsTBody.innerHTML = '';
  
  // header
  const tr = document.createElement('tr');
  tr.className = 'text-left';
  ['‡¶∞‡ßá‡¶ú‡¶ø‡¶É ‡¶®‡¶Ç','‡¶∞‡ßã‡¶≤ ‡¶®‡¶Ç','‡¶®‡¶æ‡¶Æ'].forEach(h=>{
    const th = document.createElement('th');
    th.className = 'py-3 px-3 text-xs font-semibold text-gray-300'; th.textContent = h;
    tr.appendChild(th);
  });
  // subjects header
  subjectMeta.forEach(s=>{
    const th = document.createElement('th');
    th.className = 'py-3 px-3 text-xs font-semibold text-cyan-400 min-w-[100px]'; 
    th.textContent = s.columnTitle;
    tr.appendChild(th);
  });
  studentsTHead.appendChild(tr);

  // body rows
  students.forEach(st=>{
    const row = document.createElement('tr');
    row.className = 'border-t border-gray-800 hover:bg-gray-800 transition-colors';
    
    // registration (A)
    const tdReg = document.createElement('td'); tdReg.className='py-3 px-3 text-xs'; tdReg.textContent = st.registration; row.appendChild(tdReg);
    // roll (B)
    const tdRoll = document.createElement('td'); tdRoll.className='py-3 px-3 text-xs font-bold text-cyan-300'; tdRoll.textContent = st.roll; row.appendChild(tdRoll);
    // name (C)
    const tdName = document.createElement('td'); tdName.className='py-3 px-3 text-sm text-gray-200'; tdName.textContent = st.name || ''; row.appendChild(tdName);

    // subject inputs (only english digits allowed)
    subjectMeta.forEach(s=>{
      const td = document.createElement('td'); td.className = 'py-2 px-2';
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.inputMode = 'numeric';
      inp.placeholder = '0';
      inp.className = 'p-2 rounded-md w-full max-w-[80px] text-center bg-gray-800 border border-gray-700 focus:border-cyan-500 text-sm';
      
      // restriction: english digits only
      inp.addEventListener('input', (e)=>{ e.target.value = e.target.value.replace(/[^0-9]/g,''); });
      
      // data attributes for later submission
      inp.dataset.roll = st.roll;
      inp.dataset.subject = s.subject;
      inp.dataset.columnTitle = s.columnTitle;
      td.appendChild(inp);
      row.appendChild(td);
    });

    studentsTBody.appendChild(row);
  });
}

/* ===========================
    Submit marks (collect records and call submitMarks)
    =========================== */
submitMarksBtn.addEventListener('click', async ()=>{
  if(currentSubjectMeta.length === 0){ showToast("‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§", 'error'); return; }

  // collect all inputs
  const inputs = Array.from(studentsTBody.querySelectorAll('input'));
  if(inputs.length === 0){ showToast("‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§", 'error'); return; }

  // group by subjectColumnTitle
  const grouped = {};
  inputs.forEach(inp=>{
    const col = inp.dataset.columnTitle; // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡¶ø‡¶§‡¶æ‡¶¨‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶á ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ
    if(!grouped[col]) grouped[col] = [];
    grouped[col].push({
      roll: inp.dataset.roll,
      marks: inp.value || "" // ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
    });
  });

  setButtonLoading(submitMarksBtn, true, "‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßã");
  let allSuccessful = true;
  let successCount = 0;
  
  try{
    for(const colTitle of Object.keys(grouped)){
      const payload = { 
        action: "submitMarks", 
        className: classSelect.value, 
        subjectColumnTitle: colTitle, 
        records: grouped[colTitle] 
      };
      
      const res = await apiPost(payload);
      if(!res.success){
        showToast(`"${colTitle}" ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${res.message || 'Error'}`, 'error');
        allSuccessful = false;
        // ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶≤‡ßá‡¶ì ‡¶Ö‡¶®‡ßç‡¶Ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡ßÅ‡¶™ ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ
      } else {
        successCount++;
      }
    }
    
    if(allSuccessful){
      showToast("‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üéâ", 'success');
      // ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
      studentsCard.classList.add('hidden');
      resetSubjects();
    } else {
      showToast(`${successCount}‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, 'error');
    }

  }catch(e){
    console.error(e); 
    showToast("‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§ ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", 'error');
  } finally {
    setButtonLoading(submitMarksBtn, false, "‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßã");
  }
});

/* ===========================
    ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü (‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü)
    =========================== */
function resetApp() {
    // UI ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
    mobileInput.value = '';
    idInput.value = '';
    loginStatus.classList.add('hidden');
    
    loginCard.classList.remove('hidden');
    teacherCard.classList.add('hidden');
    selectionCard.classList.add('hidden');
    studentsCard.classList.add('hidden');

    classSelect.value = '';
    resetSubjects(); // ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶ì ‡¶Æ‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
    studentsCache = [];
    
    showToast('‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ üëã', 'info');
}

/* ===========================
    Initial load: Add one subject control
    =========================== */
window.addEventListener('load', ()=>{
  // Initial subject control added after classes are loaded/populated
  loadClassesAndBooks();
});
</script>
</body>
</html>